<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Cluster</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}">
</head>
<body>
  <div class="container">
    <!-- LEFT -->
    <div class="left">
      <div class="grids">
        <!-- Cluster e3 -->
        <div class="grid-box">
          <div>E3</div>
          <div class="cluster-label-grid-3">
            <!-- 12 righe con label -->
            <!-- R12 -->
            <div class="label">R12</div>
            <div class="cell" id="e3r12p8"></div><div class="cell" id="e3r12p7"></div><div class="cell" id="e3r12p6"></div><div class="cell" id="e3r12p5"></div>
            <div class="cell" id="e3r12p4"></div><div class="cell" id="e3r12p3"></div><div class="cell" id="e3r12p2"></div><div class="cell" id="e3r12p1"></div>
            <!-- R11 -->
            <div class="label">R11</div>
            <div class="cell" id="e3r11p8"></div><div class="cell" id="e3r11p7"></div><div class="cell" id="e3r11p6"></div><div class="cell" id="e3r11p5"></div>
            <div class="cell" id="e3r11p4"></div><div class="cell" id="e3r11p3"></div><div class="cell" id="e3r11p2"></div><div class="cell" id="e3r11p1"></div>
            <!-- R10 -->
            <div class="label">R10</div>
            <div class="cell" id="e3r10p8"></div><div class="cell" id="e3r10p7"></div><div class="cell" id="e3r10p6"></div><div class="cell" id="e3r10p5"></div>
            <div class="cell" id="e3r10p4"></div><div class="cell" id="e3r10p3"></div><div class="cell" id="e3r10p2"></div><div class="cell" id="e3r10p1"></div>
            <!-- Vuoto -->
            <div class="labelx"></div>
            <div class="cellx"></div><div class="cellx"></div><div class="cellx"></div><div class="cellx"></div>
            <div class="cellx"></div><div class="cellx"></div><div class="cellx"></div><div class="cellx"></div>
            <!-- R9 -->
            <div class="label">R9</div>
            <div class="cell" id="e3r9p8"></div><div class="cell" id="e3r9p7"></div><div class="cell" id="e3r9p6"></div><div class="cell" id="e3r9p5"></div>
            <div class="cell" id="e3r9p4"></div><div class="cell" id="e3r9p3"></div><div class="cell" id="e3r9p2"></div><div class="cell" id="e3r9p1"></div>
            <!-- R8 -->
            <div class="label">R8</div>
            <div class="cell" id="e3r8p8"></div><div class="cell" id="e3r8p7"></div><div class="cell" id="e3r8p6"></div><div class="cell" id="e3r8p5"></div>
            <div class="cell" id="e3r8p4"></div><div class="cell" id="e3r8p3"></div><div class="cell" id="e3r8p2"></div><div class="cell" id="e3r8p1"></div>
            <!-- R7 -->
            <div class="label">R7</div>
            <div class="cell" id="e3r7p8"></div><div class="cell" id="e3r7p7"></div><div class="cell" id="e3r7p6"></div><div class="cell" id="e3r7p5"></div>
            <div class="cell" id="e3r7p4"></div><div class="cell" id="e3r7p3"></div><div class="cell" id="e3r7p2"></div><div class="cell" id="e3r7p1"></div>
            <!-- R6 -->
            <div class="label">R6</div>
            <div class="cell" id="e3r6p8"></div><div class="cell" id="e3r6p7"></div><div class="cell" id="e3r6p6"></div><div class="cell" id="e3r6p5"></div>
            <div class="cell" id="e3r6p4"></div><div class="cell" id="e3r6p3"></div><div class="cell" id="e3r6p2"></div><div class="cell" id="e3r6p1"></div>
            <!-- R5 -->
            <div class="label">R5</div>
            <div class="cell" id="e3r5p8"></div><div class="cell" id="e3r5p7"></div><div class="cell" id="e3r5p6"></div><div class="cell" id="e3r5p5"></div>
            <div class="cell" id="e3r5p4"></div><div class="cell" id="e3r5p3"></div><div class="cell" id="e3r5p2"></div><div class="cell" id="e3r5p1"></div>
            <!-- R4 -->
            <div class="label">R4</div>
            <div class="cell" id="e3r4p8"></div><div class="cell" id="e3r4p7"></div><div class="cell" id="e3r4p6"></div><div class="cell" id="e3r4p5"></div>
            <div class="cell" id="e3r4p4"></div><div class="cell" id="e3r4p3"></div><div class="cell" id="e3r4p2"></div><div class="cell" id="e3r4p1"></div>
            <!-- Vuoto -->
            <div class="labelx"></div>
            <div class="cellx"></div><div class="cellx"></div><div class="cellx"></div><div class="cellx"></div>
            <div class="cellx"></div><div class="cellx"></div><div class="cellx"></div><div class="cellx"></div>
            <!-- R3 -->
            <div class="label">R3</div>
            <div class="cell" id="e3r3p8"></div><div class="cell" id="e3r3p7"></div><div class="cell" id="e3r3p6"></div><div class="cell" id="e3r3p5"></div>
            <div class="cell" id="e3r3p4"></div><div class="cell" id="e3r3p3"></div><div class="cell" id="e3r3p2"></div><div class="cell" id="e3r3p1"></div>
            <!-- R2 -->
            <div class="label">R2</div>
            <div class="cell" id="e3r2p8"></div><div class="cell" id="e3r2p7"></div><div class="cell" id="e3r2p6"></div><div class="cell" id="e3r2p5"></div>
            <div class="cell" id="e3r2p4"></div><div class="cell" id="e3r2p3"></div><div class="cell" id="e3r2p2"></div><div class="cell" id="e3r2p1"></div>
            <!-- R1 -->
            <div class="label">R1</div>
            <div class="cell" id="e3r1p8"></div><div class="cell" id="e3r1p7"></div><div class="cell" id="e3r1p6"></div><div class="cell" id="e3r1p5"></div>
            <div class="cell" id="e3r1p4"></div><div class="cell" id="e3r1p3"></div><div class="cell" id="e3r1p2"></div><div class="cell" id="e3r1p1"></div>

            <!-- Etichette colonna -->
            <div class="label"></div>
            <div class="label">8</div><div class="label">7</div><div class="label">6</div><div class="label">5</div>
            <div class="label">4</div><div class="label">3</div><div class="label">2</div><div class="label">1</div>
          </div>

          <div class="info">
            <p class="spenti">Spenti ⚡️ <span>0</span></p>
            <p class="disponibili">Disponibili <span>96</span></p>
            <p class="utilizzati">Utilizzati <span>0</span></p>
            <p class="manutenzione">Manutenzione⚠️<span>0</span></p>
          </div>
        </div>

        <!-- Cluster e4: -->
        <div class="grid-box">
          <div>E4</div>
          <div class="cluster-label-grid-4">
            <div class="label">R14</div>
            <div class="cell" id="e4r14p4"></div><div class="cell" id="e4r14p3"></div><div class="cell" id="e4r14p2"></div><div class="cell" id="e4r14p1"></div>

            <div class="label">R13</div>
            <div class="cell" id="e4r13p4"></div><div class="cell" id="e4r13p3"></div><div class="cell" id="e4r13p2"></div><div class="cell" id="e4r13p1"></div>

            <div class="label">R12</div>
            <div class="cell" id="e4r12p4"></div><div class="cell" id="e4r12p3"></div><div class="cell" id="e4r12p2"></div><div class="cell" id="e4r12p1"></div>

            <div class="label">R11</div>
            <div class="cell" id="e4r11p4"></div><div class="cell" id="e4r11p3"></div><div class="cell" id="e4r11p2"></div><div class="cell" id="e4r11p1"></div>

            <div class="label">R10</div>
            <div class="cell" id="e4r10p4"></div><div class="cell" id="e4r10p3"></div><div class="cell" id="e4r10p2"></div><div class="cell" id="e4r10p1"></div>

            <div class="label">R9</div>
            <div class="cell" id="e4r9p4"></div><div class="cell" id="e4r9p3"></div><div class="cell" id="e4r9p2"></div><div class="cell" id="e4r9p1"></div>

            <div class="label">R8</div>
            <div class="cell" id="e4r8p4"></div><div class="cell" id="e4r8p3"></div><div class="cell" id="e4r8p2"></div><div class="cell" id="e4r8p1"></div>

            <div class="label">R7</div>
            <div class="cell" id="e4r7p4"></div><div class="cell" id="e4r7p3"></div><div class="cell" id="e4r7p2"></div><div class="cell" id="e4r7p1"></div>

            <div class="label">R6</div>
            <div class="cell" id="e4r6p4"></div><div class="cell" id="e4r6p3"></div><div class="cell" id="e4r6p2"></div><div class="cell" id="e4r6p1"></div>

            <div class="label">R5</div>
            <div class="cell" id="e4r5p4"></div><div class="cell" id="e4r5p3"></div><div class="cell" id="e4r5p2"></div><div class="cell" id="e4r5p1"></div>

            <div class="label">R4</div>
            <div class="cell" id="e4r4p4"></div><div class="cell" id="e4r4p3"></div><div class="cell" id="e4r4p2"></div><div class="cell" id="e4r4p1"></div>

            <div class="label">R3</div>
            <div class="cell" id="e4r3p4"></div><div class="cell" id="e4r3p3"></div><div class="cell" id="e4r3p2"></div><div class="cell" id="e4r3p1"></div>

            <div class="label">R2</div>
            <div class="cell" id="e4r2p4"></div><div class="cell" id="e4r2p3"></div><div class="cell" id="e4r2p2"></div><div class="cell" id="e4r2p1"></div>

            <div class="label">R1</div>
            <div class="cell" id="e4r1p4"></div><div class="cell" id="e4r1p3"></div><div class="cell" id="e4r1p2"></div><div class="cell" id="e4r1p1"></div>

            <!-- Etichette colonna -->
            <div class="label"></div>
            <div class="label">4</div><div class="label">3</div><div class="label">2</div><div class="label">1</div>
          </div>

          <div class="info">
            <p class="spenti">Spenti ⚡️ <span>0</span></p>
            <p class="disponibili">Disponibili <span>56</span></p>
            <p class="utilizzati">Utilizzati <span>0</span></p>
            <p class="manutenzione">Manutenzione⚠️<span>0</span></p>
          </div>
        </div>
      </div>
      {% if banner_visible %}
      <div class="banner">
        <div class="banner-content">
          {{ banner_text }}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- RIGHT -->
    <div class="right">
      {% if has_future_announcements %}
      <div class="top-right">
        <div class="event-carousel">
          <div class="event-slider" id="announcementSlider">
            {% for announcement in announcements %}
            <div class="event-card" style="background-color: {{ announcement.color }}">
              <h4 class="event-title">{{ announcement.title }}</h4>
              <p class="event-description">
                {{ announcement.description }}
              </p>
              {% if announcement.link %}
              <div class="event-info-row">
                <div class="event-info-item">
                  <div class="qr-code-container">
                    <div id="qrcode-announcement-{{ loop.index }}" class="qrcode"></div>
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      <div class="bottom-right">
        <div class="event-carousel">
          <div class="event-slider" id="eventSlider">
            <!-- Event cards will be dynamically inserted here -->
          </div>
        </div>
      </div>
      {% else %}
      <div class="top-right" style="height: calc(100vh - 30px); margin: 0;">
        <div class="event-carousel">
          <div class="event-slider" id="eventSlider">
            <!-- Event cards will be dynamically inserted here -->
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  <script>
    // Function to initialize carousel for a specific slider
    function initializeCarousel(slider) {
      const slides = slider.querySelectorAll('.event-card');
      const totalSlides = slides.length;
      let currentIndex = 0;

      // Remove existing indicators
      const carousel = slider.closest('.event-carousel');
      const existingIndicators = carousel.querySelector('.slide-indicators');
      if (existingIndicators) {
        existingIndicators.remove();
      }

      // Create slide indicators
      const indicatorsContainer = document.createElement('div');
      indicatorsContainer.className = 'slide-indicators';
      
      // Create new indicators
      slides.forEach((_, index) => {
          const indicator = document.createElement('div');
          indicator.className = 'slide-indicator';
          if (index === 0) indicator.classList.add('active');
          indicator.addEventListener('click', () => {
              const slideHeight = slides[0].offsetHeight + parseFloat(getComputedStyle(slides[0]).marginBottom);
              slider.style.transform = `translateY(-${index * slideHeight}px)`;
              currentIndex = index;
              updateIndicators();
          });
          indicatorsContainer.appendChild(indicator);
      });
      
      carousel.appendChild(indicatorsContainer);

      function updateIndicators() {
          const indicators = carousel.querySelectorAll('.slide-indicator');
          indicators.forEach((indicator, index) => {
              indicator.classList.toggle('active', index === currentIndex);
          });
      }

      // Clear any existing interval
      if (slider.carouselInterval) {
        clearInterval(slider.carouselInterval);
      }

      // Reset slider position
      slider.style.transform = 'translateY(0px)';

      if (totalSlides > 1) {
        slider.carouselInterval = setInterval(() => {
          const slideHeight = slides[0].offsetHeight + parseFloat(getComputedStyle(slides[0]).marginBottom);
          currentIndex = (currentIndex + 1) % totalSlides;
          slider.style.transform = `translateY(-${currentIndex * slideHeight}px)`;
          updateIndicators();
        }, 15000); // 15 secondi
      }
    }

    // Function to initialize all carousels
    function initializeAllCarousels() {
      document.querySelectorAll('.event-slider').forEach(slider => {
        initializeCarousel(slider);
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      // Initialize carousels on page load
      initializeAllCarousels();

      // Generate QR codes for announcements
      const announcementSlider = document.getElementById('announcementSlider');
      console.log(announcementSlider);
      if (announcementSlider) {
        const announcements = {{ announcements|tojson|safe }};
        announcements.forEach((announcement, index) => {
          if (announcement.link) {
            const qrContainer = document.getElementById(`qrcode-announcement-${index + 1}`);
            if (qrContainer) {
              new QRCode(qrContainer, {
                text: announcement.link,
                width: 100,
                height: 100,
                colorDark: "#FFFFFF",
                colorLight: "#00000000",
                correctLevel: QRCode.CorrectLevel.H
              });
            }
          }
        });
        
        // Applica il font sizing dinamico anche agli annunci
        setTimeout(applyDynamicFontSizing, 200);
      }
    });
  </script>
  <script>
    setTimeout(function() {
      location.reload();
    }, 100000); //600000);
  </script>
  <script>
    window.addEventListener('load', function() {
        fetchAndHighlight();
    });
    function fetchAndHighlight() {
        // Prima di tutto, reimposta la src di tutti gli elementi con id che iniziano con e3 o e4
        resetImages();
        
        // Usa i dati passati dal backend invece di fare fetch
        const offlinePCs = {{ offline_pcs|tojson|safe }};
        const onlinePCs = {{ online_pcs|tojson|safe }};
        
        if (offlinePCs && offlinePCs.length > 0) {
            console.log('Offline PCs:', offlinePCs);
            setOfflineLocation(offlinePCs);
        }
        
        if (onlinePCs && onlinePCs.length > 0) {
            console.log('Online PCs:', onlinePCs);
            setUsedLocation(onlinePCs);
        }

        // Set maintenance status
        const maintenancePCs = {{ maintenance_pcs|tojson|safe }};
        maintenancePCs.forEach(pcId => {
            const cell = document.getElementById(pcId);
            if (cell) {
                cell.style.color = 'var(--color-maintenance);'
                cell.style.backgroundColor = 'var(--color-maintenance);'
                cell.classList.add('maintenance');
            }
        });
    }

    function resetImages() {
        const elements = document.querySelectorAll('[id^="e3"], [id^="e4"]');
        elements.forEach(element => {
            element.style.color = "var(--color-available);"
            element.classList.remove('offline', 'maintenance', 'occupied');
            element.innerHTML = ''; // Clear any warning symbols
        });
    }

    function setOfflineLocation(ids) {
        ids.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.style.color = 'var(--color-offline);'
                element.classList.add('offline');
            }
        });
    }

    function setUsedLocation(ids) {
        ids.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.style.color = 'var(--color-occupied);'
                element.classList.add('occupied');
            }
        });
    }
  </script>
  <script>
    function updateStatistics() {
      // Funzione per contare i computer per cluster
      function countComputersByCluster(prefix) {
        const computers = document.querySelectorAll(`[id^="${prefix}"]`);
        const total = computers.length;
        
        const tmp_maintenance = document.querySelectorAll(`[id^="${prefix}"].maintenance`);
        const tmp_offline = document.querySelectorAll(`[id^="${prefix}"].offline`);
        
        // Create arrays of IDs for maintenance and offline PCs
        const maintenanceIds = Array.from(tmp_maintenance).map(el => el.id);
        const offlineIds = Array.from(tmp_offline).map(el => el.id);
        
        // Count maintenance PCs that are online (these count as offline)
        let maintenanceOnline = 0;
        maintenanceIds.forEach(id => {
          if (!offlineIds.includes(id)) {
            maintenanceOnline++;
          }
        });
        
        // Count offline PCs that are not in maintenance
        let offlineNotMaintenance = 0;
        offlineIds.forEach(id => {
          if (!maintenanceIds.includes(id)) {
            offlineNotMaintenance++;
          }
        });
        
        const maintenance = maintenanceIds.length;
        if (prefix == "e3") {
          console.log("maintenance: " + maintenance);
          console.log("maintenanceOnline: " + maintenanceOnline);
          console.log("offlineNotMaintenance: " + offlineNotMaintenance);
        }

        const offline = offlineNotMaintenance;
        const occupied = document.querySelectorAll(`[id^="${prefix}"].occupied`).length;
        const available = total - offline - maintenance - occupied;

        return {
          total,
          offline,
          maintenance,
          occupied,
          available
        };
      }

      // Aggiorna statistiche per E3
      const e3Stats = countComputersByCluster('e3');
      const e3Info = document.querySelector('.grid-box:first-child .info');
      e3Info.innerHTML = `
        <p class="spenti">Spenti ⚡️ <span>${e3Stats.offline}</span></p>
        <p class="disponibili">Disponibili <span>${e3Stats.available}</span></p>
        <p class="utilizzati">Utilizzati <span>${e3Stats.occupied}</span></p>
        <p class="manutenzione">Manutenzione⚠️<span>${e3Stats.maintenance}</span></p>
      `;

      // Aggiorna statistiche per E4
      const e4Stats = countComputersByCluster('e4');
      const e4Info = document.querySelector('.grid-box:last-child .info');
      e4Info.innerHTML = `
        <p class="spenti">Spenti ⚡️ <span>${e4Stats.offline}</span></p>
        <p class="disponibili">Disponibili <span>${e4Stats.available}</span></p>
        <p class="utilizzati">Utilizzati <span>${e4Stats.occupied}</span></p>
        <p class="manutenzione">Manutenzione⚠️ <span>${e4Stats.maintenance}</span></p>
      `;
    }

    // Aggiorna le statistiche quando la pagina si carica
    document.addEventListener('DOMContentLoaded', updateStatistics);

    // Aggiorna le statistiche ogni volta che cambia lo stato dei computer
    const observer = new MutationObserver(updateStatistics);
    const config = { attributes: true, attributeFilter: ['class'] };
    document.querySelectorAll('[id^="e3"], [id^="e4"]').forEach(element => {
      observer.observe(element, config);
    });
  </script>
  
<!--  <script>
    let container = document.querySelector('.bottom-right');
    let cards = document.querySelectorAll('.event-card');
    let index = 0;

    setInterval(() => {
      index = (index + 1) % cards.length;
      container.scrollTo({
        left: cards[index].offsetLeft,
        behavior: 'smooth'
      });
    }, 5000); // cambia ogni 5 secondi
  </script> -->
  <script>
    function formatDate(dateStr) {
        const months = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 
                       'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
        const date = new Date(dateStr);
        return `${date.getDate()} ${months[date.getMonth()]}`;
    }

    function getEventColor(kind) {
        const kindLower = kind.toLowerCase();
        if (['rush', 'piscine', 'partnership', 'exam'].includes(kindLower)) {
            return 'var(--color-exam)';
        } else if (['conference', 'meetup', 'meet_up', 'event'].includes(kindLower)) {
            return 'var(--color-event)';
        } else if (kindLower === 'association') {
            return 'var(--color-association)';
        } else if (['hackaton', 'workshop', 'challenge'].includes(kindLower)) {
            return 'var(--color-hackathon)';
        } else if (kindLower === 'extern') {
            return 'var(--color-extern)';
        }
        return 'var(--bg-box)'; // colore di default
    }

    function sanitizeId(str) {
        return str.replace(/[^a-z0-9]/gi, '-').toLowerCase();
    }

    function createEventCard(event) {
        const backgroundColor = getEventColor(event.kind);    
        const qrId = event.link ? sanitizeId(event.name) : '';
        
        return `
            <div class="event-card" style="background-color: ${backgroundColor}; color: white;">
                <h4 class="event-title">${event.name}</h4>
                <p class="event-description">
                    ${event.description || event.name}
                </p>
                <div class="event-info-row">
                    <div class="event-info-item">
                        <span class="label">Luogo</span>
                        <span class="value">${event.location}</span>
                    </div>
                    ${event.link ? `
                    <div class="event-info-item">
                        <div class="qr-code-container">
                            <div id="qrcode-${qrId}" class="qrcode"></div>
                        </div>
                    </div>
                    ` : ''}
                    <div class="event-info-item">
                        <span class="label">Data</span>
                        <span class="value">
                            ${formatDate(event.start_date)}<br>
                            ${event.begin_at.substring(0, 5)}-${event.end_at.substring(0, 5)}
                        </span>
                    </div>
                </div>
            </div>
        `;
    }

    function updateEventCarousel(data) {
        const eventSlider = document.getElementById('eventSlider');
        if (!eventSlider) return;
        
        // Clean up existing QR codes
        const existingQRCodes = eventSlider.querySelectorAll('.qrcode');
        existingQRCodes.forEach(qr => {
            qr.innerHTML = ''; // Clear the QR code content
        });
        
        eventSlider.innerHTML = data.map(event => createEventCard(event)).join('');
        
        // Generate QR codes after the cards are added to the DOM
        data.forEach(event => {
            if (event.link) {
                const qrId = sanitizeId(event.name);
                const qrContainer = document.getElementById(`qrcode-${qrId}`);
                if (qrContainer) {
                    // Clear any existing content
                    qrContainer.innerHTML = '';
                    new QRCode(qrContainer, {
                        text: event.link,
                        width: 150,
                        height: 150,
                        colorDark: "#FFFFFF",
                        colorLight: "#00000000",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                }
            }
        });

        // Reinitialize the carousel after updating content
        setTimeout(() => {
            initializeCarousel(eventSlider);
            // Applica il font sizing dinamico dopo l'aggiornamento degli eventi
            applyDynamicFontSizing();
        }, 100);
    }

    function updateCalendarEvents(data) {
        // Remove calendar update since we're not using it anymore
        return;
    }

    // Function to calculate dynamic font size based on text length
    function calculateFontSize(textLength, containerWidth = null) {
        const maxLength = 750;
        const maxFontSize = 2; // rem
        const minFontSize = 0.8; // rem
        
        if (textLength <= maxLength) {
            return maxFontSize;
        }
        
        // Calcola la riduzione proporzionale basata sulla lunghezza del testo
        const textRatio = textLength / maxLength;
        
        // Se abbiamo la larghezza del contenitore, considera anche quella
        let widthFactor = 1;
        if (containerWidth) {
            const optimalWidth = containerWidth * 0.8; // 80% della larghezza disponibile
            const estimatedTextWidth = textLength * 0.6; // Stima approssimativa della larghezza del testo
            widthFactor = Math.min(estimatedTextWidth / optimalWidth, 2);
        }
        
        // Combina i fattori di riduzione
        const reductionFactor = Math.min(textRatio * widthFactor, 4); // Massimo 4x la riduzione
        const fontSize = maxFontSize / reductionFactor;
        
        // Assicurati che non scenda sotto la dimensione minima
        return Math.max(fontSize, minFontSize);
    }

    // Function to apply dynamic font sizing to event descriptions
    function applyDynamicFontSizing() {
        const eventDescriptions = document.querySelectorAll('.event-description');
        
        eventDescriptions.forEach(description => {
            const textLength = description.textContent.length;
            const containerWidth = description.offsetWidth;
            const fontSize = calculateFontSize(textLength, containerWidth);
            
            // Applica la font-size calcolata
            description.style.fontSize = `${fontSize}rem`;
            
            // Debug info (opzionale)
            console.log(`Text length: ${textLength}, Container width: ${containerWidth}px, Font size: ${fontSize}rem`);
        });
    }

    // Usa i dati passati dal backend invece di fare fetch
    const eventsData = {{ events_data|tojson|safe }};
    if (eventsData && eventsData.length > 0) {
        console.log('Dati eventi:', eventsData);
        updateEventCarousel(eventsData);
        updateCalendarEvents(eventsData);
        
        // Applica il font sizing dinamico dopo che i contenuti sono stati caricati
        setTimeout(applyDynamicFontSizing, 100);
    } else {
        console.log('Nessun evento disponibile');
    }

    // Listener per il resize della finestra
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(applyDynamicFontSizing, 250);
    });
  </script>
</body>
</html>
